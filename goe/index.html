<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>手机跳转系统</title>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; padding: 50px; }
        .container { max-width: 600px; margin: 0 auto; background: white; padding: 30px; border-radius: 8px; }
        .message { margin: 20px 0; padding: 15px; border-radius: 5px; }
        .success { background-color: #e6ffed; color: #1a7f37; }
        .error { background-color: #ffebee; color: #c62828; }
        .warning { background-color: #fff8e1; color: #ff8f00; }
        #loading { display: inline-block; width: 20px; height: 20px; border: 3px solid rgba(0,0,0,.3); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div class="container">
        <h1>跳转系统</h1>
        <div id="status">
            <p>正在检测设备并准备跳转...</p>
            <div id="loading"></div>
        </div>
    </div>

    <script>
        // 生成随机4字母子域名
        function generateRandomSubdomain() {
            return Array.from({length: 4}, () => 
                'abcdefghijklmnopqrstuvwxyz'[Math.floor(Math.random() * 26)]
            ).join('');
        }
        
        // 检测是否为移动设备
        function isMobileDevice() {
            return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        }
        
        // 提取主域名
        function extractMainDomain(url) {
            try {
                // 处理URL格式
                let domain = url;
                if (!domain.startsWith('http')) {
                    domain = 'https://' + domain;
                }
                
                const domainObj = new URL(domain);
                let hostname = domainObj.hostname.replace('www.', '');
                
                // 提取主域名 (最后两部分)
                const parts = hostname.split('.');
                return parts.slice(-2).join('.');
            } catch {
                return '';
            }
        }
        
        // 更新状态显示
        function updateStatus(type, message, targetUrl = '') {
            const statusDiv = document.getElementById('status');
            const messages = {
                error: `<div class="message error"><h2>系统错误</h2><p>${message}</p></div>`,
                warning: `<div class="message warning"><h2>此链接仅限手机访问</h2><p>${message}</p>${targetUrl ? `<p>目标URL: ${targetUrl}</p>` : ''}</div>`,
                success: `<div class="message success"><p>跳转中，请稍候...</p><p>目标URL: ${targetUrl}</p></div>`
            };
            statusDiv.innerHTML = messages[type] || '';
        }
        
        // 主执行函数
        async function executeRedirect() {
            try {
                // 1. 检测设备类型
                if (!isMobileDevice()) {
                    updateStatus('warning', '请使用手机设备打开此链接');
                    return;
                }
                
                // 2. 通过本地PHP代理获取链接列表
                const response = await fetch('proxy.php');
                if (!response.ok) throw new Error('无法获取链接列表: HTTP '+response.status);
                
                const text = await response.text();
                console.log('获取到的内容:', text); // 调试用
                
                const validLinks = text.split('\n')
                    .map(line => line.trim())
                    .filter(line => line && !line.startsWith('#'));
                
                if (!validLinks.length) throw new Error('没有可用的链接');
                
                // 3. 提取主域名并生成随机子域名
                const mainDomain = extractMainDomain(validLinks[0]);
                if (!mainDomain) throw new Error('无效的链接格式: '+validLinks[0]);
                
                const randomSub = generateRandomSubdomain();
                const targetUrl = `https://${randomSub}.${mainDomain}`;
                
                // 4. 显示跳转信息并执行跳转
                updateStatus('success', '', targetUrl);
                setTimeout(() => {
                    window.location.href = targetUrl;
                }, 1500);
                
            } catch (error) {
                updateStatus('error', error.message);
                console.error('跳转错误:', error);
            }
        }
        
        // 页面加载后执行
        document.addEventListener('DOMContentLoaded', executeRedirect);
    </script>
</body>
</html>